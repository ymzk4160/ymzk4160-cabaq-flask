{% extends 'base.html' %}

{% block title %}ã‚­ãƒ£ãƒå¬¢Q&A - åŒ¿åæ²ç¤ºæ¿{% endblock %}

{% block head_js %}
<script>
  function filterCategory(category) {
    const items = document.querySelectorAll('.qa-item');
    items.forEach(item => {
      if (category === 'all' || item.dataset.category === category) {
        item.classList.remove('hidden');
      } else {
        item.classList.add('hidden');
      }
    });

    const buttons = document.querySelectorAll('.category-button');
    buttons.forEach(btn => btn.classList.remove('bg-pink-400', 'text-white'));
    const activeBtn = document.querySelector(`[data-category-btn="${category}"]`);
    if (activeBtn) activeBtn.classList.add('bg-pink-400', 'text-white');
  }
</script>
{% endblock %}

{% block content %}
  <!-- ä¼šå“¡ç™»éŒ²æ¡ˆå†… -->
<section class="bg-pink-100 text-center p-4 text-sm">
  <p class="mb-1 font-semibold">ğŸ” ã“ã®å…ˆã®Q&Aã‚’ã‚‚ã£ã¨èª­ã¿ãŸã„ï¼Ÿ</p>
  <p class="mb-1">
    ç°¡å˜ãªä¼šå“¡ç™»éŒ²ã§ <span class="font-bold">æœ€åˆã®10æ—¥é–“ã¯ç„¡æ–™</span>ï¼<br>
    ãã®å¾Œã€åˆå›3ã‹æœˆã¯æœˆé¡ <span class="font-bold">1,000å††</span>ã€<br>
    ä»¥é™ã‚‚æœˆé¡ <span class="font-bold">1,000å††</span> ã§ã™ã¹ã¦è¦‹æ”¾é¡Œã«âœ¨
  </p>
  <p class="mb-1 text-xs text-gray-600">â€»ç„¡æ–™ä¼šå“¡ç™»éŒ²ã¯æ•°ç§’ã§å®Œäº†ã€æ”¯æ‰•ã„æƒ…å ±ã®ç™»éŒ²ã¯ä¸è¦ã§ã™ã€‚</p>
  <p class="mb-1 text-xs text-gray-600">â€»ç¶™ç¶šåˆ©ç”¨ã”å¸Œæœ›ã®å ´åˆã«ã¯ã€æ”¯æ‰•ã„æƒ…å ±ã®ç™»éŒ²ãŒå¿…è¦ã§ã™ã€‚</p>
  <p class="mb-1 text-xs text-gray-600">â€»æ”¯æ‰•ã„æƒ…å ±ãŒæœªç™»éŒ²ã®å ´åˆã€10æ—¥å¾Œã«åˆ©ç”¨ä¸å¯ã¨ãªã‚Šã¾ã™ã€‚</p>
  <button class="mt-2 bg-pink-400 hover:bg-pink-500 text-white text-sm px-6 py-2 rounded-full">
    ä»Šã™ãç„¡æ–™ä¼šå“¡ç™»éŒ²
  </button>
</section>


<!-- é›²å½¢ã®ä¸­ã§ãƒ©ãƒ³ãƒ€ãƒ é…ç½®ã•ã‚Œã‚‹ã‚«ãƒ†ã‚´ãƒªãƒ¼ -->
<div class="p-2 bg-white shadow relative">
  <!-- é›²å½¢ã®èƒŒæ™¯ -->
  <svg class="cloud-bg absolute top-0 left-0 w-full h-full" viewBox="0 0 400 150" preserveAspectRatio="none">
    <path d="M25,100 
      C35,120 45,130 75,130 
      C85,130 100,120 110,115 
      C125,110 150,100 170,110 
      C180,115 190,130 200,130 
      C220,130 230,115 240,110 
      C265,100 285,110 300,120 
      C330,135 350,120 360,100 
      C370,80 365,70 350,65 
      C340,60 330,55 340,45 
      C350,35 340,20 325,15 
      C310,10 280,20 275,30 
      C270,40 260,35 245,30 
      C230,25 210,35 200,40 
      C190,35 175,25 160,30 
      C145,35 130,50 125,55 
      C115,65 95,65 85,60 
      C75,55 60,60 50,70 
      C40,80 25,80 25,100" 
      fill="#FDF2F8" stroke="#F9A8D4" stroke-width="2"></path>
  </svg>
  
  <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒœã‚¿ãƒ³ã‚’é…ç½®ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ -->
  <div id="category-container" class="relative min-h-[150px]">
    <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒœã‚¿ãƒ³ã¯JavaScriptã§å‹•çš„ã«é…ç½®ã•ã‚Œã¾ã™ -->
  </div>
</div>

<script>
  // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ãƒ‡ãƒ¼ã‚¿
  const categories = [
    { id: 'all', name: 'ã™ã¹ã¦', color: 'bg-pink-400 text-white' },
    { id: 'åˆå¿ƒè€…', name: 'åˆå¿ƒè€…', color: 'bg-pink-200 hover:bg-pink-300' },
    { id: 'å–¶æ¥­', name: 'å–¶æ¥­', color: 'bg-pink-200 hover:bg-pink-300' },
    { id: 'å‡ºå‹¤', name: 'å‡ºå‹¤', color: 'bg-pink-200 hover:bg-pink-300' },
    { id: 'ãƒãƒ¼ã‚¹ãƒ‡ã‚¤', name: 'ãƒãƒ¼ã‚¹ãƒ‡ã‚¤', color: 'bg-pink-200 hover:bg-pink-300' },
    { id: 'ãƒ¡ãƒ³ã‚¿ãƒ«', name: 'ãƒ¡ãƒ³ã‚¿ãƒ«', color: 'bg-pink-200 hover:bg-pink-300' },
    { id: 'èº«ãƒãƒ¬', name: 'èº«ãƒãƒ¬', color: 'bg-pink-200 hover:bg-pink-300' },
    { id: 'åº—ä¸æº€', name: 'åº—ã¸ã®ä¸æº€', color: 'bg-pink-200 hover:bg-pink-300' },
    { id: 'ç¾å®¹', name: 'ç¾å®¹', color: 'bg-pink-200 hover:bg-pink-300' },
    { id: 'æ‹æ„›', name: 'æ‹æ„›', color: 'bg-pink-200 hover:bg-pink-300' },
    { id: 'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ', name: 'ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ', color: 'bg-pink-200 hover:bg-pink-300' }
  ];

  // è¡çªæ¤œå‡ºï¼š2ã¤ã®ãƒœã‚¿ãƒ³ãŒé‡ãªã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  function isColliding(pos1, size1, pos2, size2) {
    return !(
      pos1.left + size1.width < pos2.left ||
      pos1.top + size1.height < pos2.top ||
      pos1.left > pos2.left + size2.width ||
      pos1.top > pos2.top + size2.height
    );
  }

  // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒœã‚¿ãƒ³ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é…ç½®ã™ã‚‹é–¢æ•°
  function randomizeCategories() {
    const container = document.getElementById('category-container');
    container.innerHTML = ''; // ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
    
    // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    const shuffledCategories = [...categories].sort(() => Math.random() - 0.5);
    
    // é…ç½®æ¸ˆã¿ã®ãƒœã‚¿ãƒ³ã®ä½ç½®ã¨ã‚µã‚¤ã‚ºã‚’æ ¼ç´ã™ã‚‹é…åˆ—
    const placedButtons = [];
    
    // ã‚³ãƒ³ãƒ†ãƒŠã®ã‚µã‚¤ã‚ºã‚’å–å¾—
    const containerWidth = container.offsetWidth;
    const containerHeight = 150; // å›ºå®šã®é«˜ã•ã‚’è¨­å®š
    
    // å„ãƒœã‚¿ãƒ³ã®ãŠãŠã‚ˆãã®ã‚µã‚¤ã‚ºï¼ˆãƒ†ã‚­ã‚¹ãƒˆã®é•·ã•ã«å¿œã˜ã¦èª¿æ•´ï¼‰
    const buttonSizes = shuffledCategories.map(category => {
      return {
        width: Math.max(category.name.length * 10 + 20, 60), // æ–‡å­—æ•°ã«å¿œã˜ãŸå¹… + ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°
        height: 30
      };
    });
    
    // ãƒœã‚¿ãƒ³ã‚’é…ç½®
    shuffledCategories.forEach((category, index) => {
      const buttonSize = buttonSizes[index];
      let position;
      let attempts = 0;
      let found = false;
      
      // è¡çªã—ãªã„ä½ç½®ã‚’è¦‹ã¤ã‘ã‚‹ã¾ã§è©¦è¡Œ
      while (!found && attempts < 100) {
        attempts++;
        
        // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã‚’ç”Ÿæˆï¼ˆé›²å½¢ã®ä¸­ã«åã¾ã‚‹ã‚ˆã†ã«ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è€ƒæ…®ï¼‰
        const padding = 20;
        position = {
          left: padding + Math.random() * (containerWidth - buttonSize.width - (padding * 2)),
          top: padding + Math.random() * (containerHeight - buttonSize.height - (padding * 2))
        };
        
        // ä»–ã®ãƒœã‚¿ãƒ³ã¨ã®è¡çªã‚’ãƒã‚§ãƒƒã‚¯
        found = true;
        for (const placedButton of placedButtons) {
          if (isColliding(position, buttonSize, placedButton.position, placedButton.size)) {
            found = false;
            break;
          }
        }
      }
      
      // ä½ç½®ãŒè¦‹ã¤ã‹ã£ãŸã‚‰ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
      if (found) {
        const button = document.createElement('button');
        button.className = `category-button absolute text-sm px-3 py-1 rounded-full ${category.color} shadow-sm`;
        button.setAttribute('onclick', `filterCategory('${category.id}')`);
        button.setAttribute('data-category-btn', category.id);
        button.textContent = category.name;
        
        button.style.left = `${position.left}px`;
        button.style.top = `${position.top}px`;
        // ãµã‚ãµã‚ã¨æµ®ã„ã¦ã„ã‚‹ã‚ˆã†ãªè»½ã„ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœã‚’è¿½åŠ 
        button.style.animation = `float ${2 + Math.random() * 2}s ease-in-out infinite`;
        
        container.appendChild(button);
        
        // é…ç½®æ¸ˆã¿ãƒœã‚¿ãƒ³ãƒªã‚¹ãƒˆã«è¿½åŠ 
        placedButtons.push({
          position: position,
          size: buttonSize
        });
      } else {
        // ä½ç½®ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€ä¸‹éƒ¨ã«ãƒ•ãƒ­ãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§è¿½åŠ 
        const button = document.createElement('button');
        button.className = `category-button inline-block text-sm px-3 py-1 rounded-full m-1 ${category.color} shadow-sm`;
        button.setAttribute('onclick', `filterCategory('${category.id}')`);
        button.setAttribute('data-category-btn', category.id);
        button.textContent = category.name;
        
        // çµ¶å¯¾ä½ç½®æŒ‡å®šã§ã¯ãªãã€é€šå¸¸ã®ãƒ•ãƒ­ãƒ¼ã«è¿½åŠ 
        button.style.position = 'relative';
        container.appendChild(document.createElement('div')).appendChild(button);
      }
    });
  }
  
  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ 
  const style = document.createElement('style');
  style.textContent = `
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
  `;
  document.head.appendChild(style);
  
  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ãƒ©ãƒ³ãƒ€ãƒ é…ç½®
  document.addEventListener('DOMContentLoaded', randomizeCategories);
  
  // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é–¢æ•°
  function filterCategory(category) {
    // ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚³ãƒ¼ãƒ‰
    const items = document.querySelectorAll('.qa-item');
    items.forEach(item => {
      if (category === 'all' || item.dataset.category === category) {
        item.classList.remove('hidden');
      } else {
        item.classList.add('hidden');
      }
    });
    
    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¦–è¦šçš„ã«å¼·èª¿è¡¨ç¤º
    const buttons = document.querySelectorAll('[data-category-btn]');
    buttons.forEach(btn => {
      if (btn.getAttribute('data-category-btn') === category) {
        if (category !== 'all') {
          btn.classList.add('bg-pink-400', 'text-white');
          btn.classList.remove('bg-pink-200', 'hover:bg-pink-300');
        }
      } else if (btn.getAttribute('data-category-btn') === 'all') {
        btn.classList.add('bg-pink-400', 'text-white');
      } else {
        btn.classList.remove('bg-pink-400', 'text-white');
        btn.classList.add('bg-pink-200', 'hover:bg-pink-300');
      }
    });
  }
</script>




<!-- æœ€æ–°Q&Aãƒªã‚¹ãƒˆ -->
  <section class="p-3">
    <h2 class="text-lg font-bold mb-3">ğŸ“Œ æœ€æ–°ã®è³ªå•ï¼ˆ{{ questions|length }}ä»¶ï¼‰</h2>
    <div class="space-y-3">
      {% if questions %}
        {% for question in questions %}
          <div class="qa-item bg-white p-3 rounded-xl shadow" data-category="{{ question.category }}">
            <h3 class="font-semibold text-base">Q. {{ question.title }}</h3>
            <p class="text-xs text-gray-500 mb-1">ğŸ’¬ å›ç­”æ•°ï¼š{{ question.answer_count }}ä»¶</p>
            {% if question.answers %}
              <p class="mt-1 text-sm text-gray-800">A. {{ question.answers[0].content|truncate(50) }}</p>
            {% else %}
              <p class="mt-1 text-sm text-gray-500 italic">ã¾ã å›ç­”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <div class="text-center py-4 bg-white rounded-xl shadow">
          <p class="text-gray-500">ã¾ã è³ªå•ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
          <button class="mt-2 bg-pink-400 hover:bg-pink-500 text-white text-sm px-6 py-2 rounded-full">æœ€åˆã®è³ªå•ã‚’æŠ•ç¨¿ã™ã‚‹</button>
        </div>
      {% endif %}
    </div>
  </section>
{% endblock %}
