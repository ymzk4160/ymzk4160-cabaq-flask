{% extends 'base.html' %}

{% block title %}キャバ嬢Q&A - 匿名掲示板{% endblock %}

{% block head_js %}
<script>
  function filterCategory(category) {
    const items = document.querySelectorAll('.qa-item');
    items.forEach(item => {
      if (category === 'all' || item.dataset.category === category) {
        item.classList.remove('hidden');
      } else {
        item.classList.add('hidden');
      }
    });

    const buttons = document.querySelectorAll('.category-button');
    buttons.forEach(btn => btn.classList.remove('bg-pink-400', 'text-white'));
    const activeBtn = document.querySelector(`[data-category-btn="${category}"]`);
    if (activeBtn) activeBtn.classList.add('bg-pink-400', 'text-white');
  }
</script>
{% endblock %}

{% block content %}
  <!-- 会員登録案内 -->
<section class="bg-pink-100 text-center p-4 text-sm">
  <p class="mb-1 font-semibold">🔐 この先のQ&Aをもっと読みたい？</p>
  <p class="mb-1">
    簡単な会員登録で <span class="font-bold">最初の10日間は無料</span>！<br>
    その後、初回3か月は月額 <span class="font-bold">1,000円</span>、<br>
    以降も月額 <span class="font-bold">1,000円</span> ですべて見放題に✨
  </p>
  <p class="mb-1 text-xs text-gray-600">※無料会員登録は数秒で完了、支払い情報の登録は不要です。</p>
  <p class="mb-1 text-xs text-gray-600">※継続利用ご希望の場合には、支払い情報の登録が必要です。</p>
  <p class="mb-1 text-xs text-gray-600">※支払い情報が未登録の場合、10日後に利用不可となります。</p>
  <button class="mt-2 bg-pink-400 hover:bg-pink-500 text-white text-sm px-6 py-2 rounded-full">
    今すぐ無料会員登録
  </button>
</section>


<!-- カテゴリー（グリッドベースのランダム配置＋アニメーション・枠内収まり保証） -->
<div id="category-container" class="p-2 bg-white shadow relative min-h-[150px]">
  <!-- カテゴリーボタンはJavaScriptで動的に配置されます -->
</div>

<script>
  // カテゴリーのデータ
  const categories = [
    { id: 'all', name: 'すべて', color: 'bg-pink-400 text-white' },
    { id: '初心者', name: '初心者', color: 'bg-pink-200 hover:bg-pink-300' },
    { id: '営業', name: '営業', color: 'bg-pink-200 hover:bg-pink-300' },
    { id: '出勤', name: '出勤', color: 'bg-pink-200 hover:bg-pink-300' },
    { id: 'バースデイ', name: 'バースデイ', color: 'bg-pink-200 hover:bg-pink-300' },
    { id: 'メンタル', name: 'メンタル', color: 'bg-pink-200 hover:bg-pink-300' },
    { id: '身バレ', name: '身バレ', color: 'bg-pink-200 hover:bg-pink-300' },
    { id: '店不満', name: '店への不満', color: 'bg-pink-200 hover:bg-pink-300' },
    { id: '美容', name: '美容', color: 'bg-pink-200 hover:bg-pink-300' },
    { id: '恋愛', name: '恋愛', color: 'bg-pink-200 hover:bg-pink-300' },
    { id: 'プライベート', name: 'プライベート', color: 'bg-pink-200 hover:bg-pink-300' }
  ];

  // アニメーションのためのスタイルを追加
  const style = document.createElement('style');
  style.textContent = `
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
  `;
  document.head.appendChild(style);

  // カテゴリーボタンをグリッドベースでランダムに配置する関数
  function randomizeCategories() {
    const container = document.getElementById('category-container');
    container.innerHTML = ''; // コンテナをクリア
    
    // コンテナのサイズを取得
    const containerWidth = container.offsetWidth;
    const containerHeight = 150;
    container.style.minHeight = containerHeight + 'px';
    
    // グリッドの設定
    const columns = 4; // 横のセル数
    const rows = 3;    // 縦のセル数
    
    const cellWidth = containerWidth / columns;
    const cellHeight = containerHeight / rows;
    
    // グリッドセルの状態を管理（配置済みかどうか）
    const gridCells = Array(rows).fill().map(() => Array(columns).fill(false));
    
    // 「すべて」ボタンは左上のセルに固定
    const allButton = document.createElement('button');
    allButton.className = `category-button absolute text-sm px-3 py-1 rounded-full bg-pink-400 text-white shadow-sm`;
    allButton.setAttribute('onclick', `filterCategory('all')`);
    allButton.setAttribute('data-category-btn', 'all');
    allButton.textContent = 'すべて';
    
    // ボタンのサイズを推定（テキスト長に基づく）
    const allButtonWidth = Math.max(allButton.textContent.length * 10 + 20, 60);
    const allButtonHeight = 30;
    
    // セル内でボタンが収まる範囲でランダムな位置
    const allButtonX = 10 + Math.random() * (cellWidth - allButtonWidth - 20);
    const allButtonY = 10 + Math.random() * (cellHeight - allButtonHeight - 20);
    
    allButton.style.left = `${allButtonX}px`;
    allButton.style.top = `${allButtonY}px`;
    allButton.style.animation = 'none'; // すべてボタンはアニメーションなし
    
    container.appendChild(allButton);
    gridCells[0][0] = true; // 左上のセルを使用済みにマーク
    
    // 残りのカテゴリーボタンをシャッフル
    const shuffledCategories = [...categories.slice(1)].sort(() => Math.random() - 0.5);
    
    // ボタンを配置
    shuffledCategories.forEach((category, index) => {
      // ランダムなグリッドセルを選択（まだ使われていないものから）
      let row, col;
      let found = false;
      let attempts = 0;
      
      // 空いているセルを探す
      while (!found && attempts < 50) {
        row = Math.floor(Math.random() * rows);
        col = Math.floor(Math.random() * columns);
        
        if (!gridCells[row][col]) {
          found = true;
          gridCells[row][col] = true; // セルを使用済みにマーク
        }
        attempts++;
      }
      
      // 空いているセルが見つからない場合は、既に使用済みのセルをランダムに選択
      if (!found) {
        row = Math.floor(Math.random() * rows);
        col = Math.floor(Math.random() * columns);
      }
      
      const button = document.createElement('button');
      button.className = `category-button absolute text-sm px-3 py-1 rounded-full ${category.color} shadow-sm`;
      button.setAttribute('onclick', `filterCategory('${category.id}')`);
      button.setAttribute('data-category-btn', category.id);
      button.textContent = category.name;
      
      // ボタンのサイズを推定（テキスト長に基づく）
      const buttonWidth = Math.max(category.name.length * 10 + 20, 60);
      const buttonHeight = 30;
      
      // セル内でボタンが確実に収まる範囲でランダムな位置を計算
      const xOffset = Math.random() * (cellWidth - buttonWidth - 20);
      const yOffset = Math.random() * (cellHeight - buttonHeight - 20);
      
      // 最終的なボタン位置（枠内に収まることを保証）
      const buttonX = Math.max(10, Math.min(containerWidth - buttonWidth - 10, col * cellWidth + xOffset));
      const buttonY = Math.max(10, Math.min(containerHeight - buttonHeight - 10, row * cellHeight + yOffset));
      
      button.style.left = `${buttonX}px`;
      button.style.top = `${buttonY}px`;
      
      // ふわふわと浮いているようなアニメーション効果を追加
      const animationDuration = 2 + Math.random() * 2; // 2〜4秒のランダムな時間
      button.style.animation = `float ${animationDuration}s ease-in-out infinite`;
      // アニメーションの開始時間をずらす
      button.style.animationDelay = `${Math.random() * 2}s`;
      
      container.appendChild(button);
    });
  }
  
  // ページ読み込み時にカテゴリーをランダム配置
  document.addEventListener('DOMContentLoaded', randomizeCategories);
  
  // カテゴリーフィルター関数
  function filterCategory(category) {
    // 現在のフィルタリングコード
    const items = document.querySelectorAll('.qa-item');
    items.forEach(item => {
      if (category === 'all' || item.dataset.category === category) {
        item.classList.remove('hidden');
      } else {
        item.classList.add('hidden');
      }
    });
    
    // カテゴリーボタンの強調表示
    const buttons = document.querySelectorAll('[data-category-btn]');
    buttons.forEach(btn => {
      if (btn.getAttribute('data-category-btn') === category) {
        if (category !== 'all') {
          btn.classList.add('bg-pink-400', 'text-white');
          btn.classList.remove('bg-pink-200', 'hover:bg-pink-300');
        }
      } else if (btn.getAttribute('data-category-btn') === 'all') {
        // すべてボタンは常に特別なスタイル
      } else {
        btn.classList.remove('bg-pink-400', 'text-white');
        btn.classList.add('bg-pink-200', 'hover:bg-pink-300');
      }
    });
    
    // フィルター後にボタンを再配置
    randomizeCategories();
  }
</script>




<!-- 最新Q&Aリスト -->
  <section class="p-3">
    <h2 class="text-lg font-bold mb-3">📌 最新の質問（{{ questions|length }}件）</h2>
    <div class="space-y-3">
      {% if questions %}
        {% for question in questions %}
          <div class="qa-item bg-white p-3 rounded-xl shadow" data-category="{{ question.category }}">
            <h3 class="font-semibold text-base">Q. {{ question.title }}</h3>
            <p class="text-xs text-gray-500 mb-1">💬 回答数：{{ question.answer_count }}件</p>
            {% if question.answers %}
              <p class="mt-1 text-sm text-gray-800">A. {{ question.answers[0].content|truncate(50) }}</p>
            {% else %}
              <p class="mt-1 text-sm text-gray-500 italic">まだ回答がありません。</p>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <div class="text-center py-4 bg-white rounded-xl shadow">
          <p class="text-gray-500">まだ質問がありません。</p>
          <button class="mt-2 bg-pink-400 hover:bg-pink-500 text-white text-sm px-6 py-2 rounded-full">最初の質問を投稿する</button>
        </div>
      {% endif %}
    </div>
  </section>
{% endblock %}
