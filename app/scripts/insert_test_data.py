# app/scripts/insert_test_data.py
from app import create_app
from app.extensions import db
from app.models.category import Category
from app.models.question import Question
from app.models.answer import Answer
from app.models.user import User

def insert_test_data():
    """テストデータをデータベースに投入する関数"""
    # アプリケーションコンテキストを作成
    app = create_app()
    with app.app_context():
        try:
            # 既存のデータを確認
            existing_user = User.query.filter_by(email='test@example.com').first()
            if not existing_user:
                # ユーザーの作成
                user = User(
                    email='test@example.com',
                    nickname='テストユーザー',
                    password_hash='dummy_hash'
                )
                db.session.add(user)
                db.session.flush()  # IDを取得
            else:
                user = existing_user
                
            # カテゴリの作成
            categories = {}
            for cat_name in ['初心者', '営業', '出勤', 'メンタル', '店不満', '身バレ', 'スキルアップ', '接客術', '人間関係', '給料', '美容', 'ファッション']:
                existing_cat = Category.query.filter_by(name=cat_name).first()
                if not existing_cat:
                    category = Category(name=cat_name)
                    db.session.add(category)
                    db.session.flush()
                    categories[cat_name] = category
                else:
                    categories[cat_name] = existing_cat
            
            # 一度コミットして ID を確定させる
            db.session.commit()
            
            # 質問と回答のデータ
            test_data = [
                # 初期の10件
                {
                    'title': '初めてのキャバクラ勤務、何を準備すべき？',
                    'content': '来週から初めてキャバクラで働きます。ドレスやメイク道具など、最低限必要なものを教えてください。',
                    'category': '初心者',
                    'answers': [
                        'まずは基本的なメイク道具とシンプルな黒のドレス1着があれば大丈夫です。最初は高すぎるものに手を出さず、仕事に慣れてから徐々に増やしていくことをお勧めします。'
                    ]
                },
                {
                    'title': '大箱と小箱、初心者はどちらがいい？',
                    'content': 'これからキャバ嬢デビューしようと思ってます。大きい店と小さい店、どちらから始めるべきでしょうか？',
                    'category': '初心者',
                    'answers': [
                        '小箱の方が先輩との距離が近く、教えてもらいやすいです。大箱は競争が激しいけど稼げるチャンスは大きいです。'
                    ]
                },
                {
                    'title': '売上アップのための会話術、おすすめは？',
                    'content': '最近売上が伸び悩んでいます。お客様との会話を盛り上げるコツは？',
                    'category': '営業',
                    'answers': [
                        'お客様の話をしっかり聞くことが一番です。相手の趣味や仕事の話を掘り下げて、「詳しいですね！」と褒めると喜ばれます。'
                    ]
                },
                {
                    'title': '同伴のお誘いのタイミングと方法',
                    'content': '同伴のお誘いって、どのタイミングでどう切り出すのが効果的ですか？',
                    'category': '営業',
                    'answers': [
                        '次の来店日を聞いたときに「その日のお仕事終わり、ご一緒できたら嬉しいです」と誘うのがスムーズです。'
                    ]
                },
                {
                    'title': '効率的なシフトの組み方は？',
                    'content': '週4〜5で働いていますが、どういう曜日の組み合わせが効率良いですか？',
                    'category': '出勤',
                    'answers': [
                        '金土は必須です。あとは水曜も意外と穴場です。私のおすすめは「水・金・土・日または月」の4出勤です。'
                    ]
                },
                {
                    'title': '体調不良での当日欠勤、皆さんどうしてる？',
                    'content': '急な体調不良で欠勤することになった場合、どう連絡するのがマナーですか？',
                    'category': '出勤',
                    'answers': [
                        'できるだけ早く連絡することが大事です。遅くとも出勤の3時間前までには。ちゃんと理由も伝えて、次回必ず出勤することを伝えると印象が違います。'
                    ]
                },
                {
                    'title': '仕事のストレス発散法、みんなどうしてる？',
                    'content': '最近、仕事のストレスが溜まっていて、休日も気分転換できません。',
                    'category': 'メンタル',
                    'answers': [
                        '私はジムに通っています。運動すると気分転換になるし、仕事にも活かせます。あとは趣味に没頭する時間を作ることも大事ですよ。'
                    ]
                },
                {
                    'title': '夜職と昼職の両立、精神的にきつい',
                    'content': '昼は事務職、夜はキャバクラで働いています。最近、睡眠不足で精神的にも辛いです。',
                    'category': 'メンタル',
                    'answers': [
                        '私も経験ありますが、長期的には難しいです。無理せず夜職は週末だけにするなど調整した方がいいです。体調崩すと両方できなくなります。'
                    ]
                },
                {
                    'title': 'ノルマがきつい店、移籍すべき？',
                    'content': '今の店はノルマが厳しすぎて毎月赤字になることも…。でも常連さんもいるので移籍に踏み切れません。',
                    'category': '店不満',
                    'answers': [
                        '常連さんが多いなら、移籍前に連絡先を交換しておくことをお勧めします。私は移籍時に7割の常連さんに新しい店に来てもらえました。'
                    ]
                },
                {
                    'title': '地元でのお仕事、身バレリスク対策は？',
                    'content': '実家から近いエリアで働いています。知り合いに会う可能性があり心配です。',
                    'category': '身バレ',
                    'answers': [
                        'メイクを普段と大きく変える、カラコンやウィッグを使うなど外見を変えるのが基本です。あとはSNSの設定を見直して、位置情報をオフにするのも忘れずに。'
                    ]
                },
                
                # 追加の質問データ
                {
                    'title': '新人さんへの指名の取り方アドバイス',
                    'content': 'デビュー2週間目です。まだ指名が全然ないのですが、どうやって指名を増やしていけばいいでしょうか？',
                    'category': '営業',
                    'answers': [
                        '最初は「話しやすい子」という印象を作ることが大事です。お客様の話をよく聞いて、次に来店されたとき「前回〇〇のお話をされてましたよね」と覚えていることをアピールすると喜ばれます。また、店内で先輩の接客を観察して学ぶのもおすすめです。'
                    ]
                },
                {
                    'title': '髪型で人気が出るスタイルってありますか？',
                    'content': 'イメチェンしようと思っています。お客様ウケがいい髪型やカラーがあれば教えてください。',
                    'category': '美容',
                    'answers': [
                        '清楚系なら黒髪のロングストレートが鉄板です。派手目にいくなら、ハイトーンのゆるふわパーマも人気です。ただ一番大事なのは自分に似合う髪型で、自信を持って接客できることだと思います。',
                        '私の場合は、ミディアムのゆるふわパーマにしたら人気が出ました。あまり派手すぎると苦手なお客様もいるので、バランスが大事だと思います。'
                    ]
                },
                {
                    'title': 'お酒が弱いのですが対策ありますか？',
                    'content': '3杯も飲むとすぐに赤くなって気持ち悪くなります。仕事に支障が出そうで心配です。',
                    'category': '接客術',
                    'answers': [
                        '事前に整腸剤や胃薬を飲んでおくと少し効果があります。また、お水をこまめに飲むこと、食事をしっかり取っておくことも大事です。それでも厳しいなら、「作り」と呼ばれる方法もあります。見た目はお酒に見えるジンジャーエールなどを飲むという手もありますよ。',
                        'わたしも弱いので、最初にお客様に正直に伝えています。「お酒弱いんですが、少しずつ頑張ります」と言うと、逆にかわいがってくれるお客様も多いです。'
                    ]
                },
                {
                    'title': 'ドレス選びのコツを教えてください',
                    'content': '最近ドレスを新調しようと思っていますが、どんなデザインや色が人気ですか？あと予算の目安も知りたいです。',
                    'category': 'ファッション',
                    'answers': [
                        '店のコンセプトに合わせることが一番大事です。高級店なら上品な感じ、派手な店ならインパクトのあるものを選びましょう。色は黒やネイビーは鉄板ですが、差をつけるなら赤やパステルカラーも良いと思います。予算は3〜5万円が目安ですが、最初は安めのものから徐々に増やしていくといいですよ。'
                    ]
                },
                {
                    'title': '先輩との付き合い方で気をつけることは？',
                    'content': '来週から新しいお店で働きます。先輩との関係で失敗したくないのですが、気をつけるべきことはありますか？',
                    'category': '人間関係',
                    'answers': [
                        '挨拶はしっかりと、敬語は忘れずに、そして先輩の仕事の邪魔にならないようにすることが基本です。あとは、わからないことは素直に質問する姿勢も大事です。ただし、忙しそうなときは避けて、タイミングを見計らいましょう。',
                        '小さなことですが、お店のロッカールームでは自分のスペースをきちんと保つこと、共有スペースはキレイに使うことも印象が良くなります。些細なことですが、気遣いができる子だと思ってもらえますよ。'
                    ]
                },
                {
                    'title': 'お給料の管理方法、みなさんどうしてる？',
                    'content': '稼ぎはいいけれど使いすぎてしまい、お金が貯まりません。効果的な貯金方法やお金の管理術を教えてください。',
                    'category': '給料',
                    'answers': [
                        '給料日に即座に一定額を別の口座に移すことをおすすめします。私は給料の30%を強制的に貯金用口座に入れています。また、1日の使用限度額を決めて、それを超えないように意識するのも効果的です。',
                        '私は家賃や固定費を先に引いた後、残りを「遊び用」「貯金用」「美容投資用」と3つに分けています。特に貯金は「見えない場所」に置くことが重要で、ネットバンキングのアプリは入れないようにしています。目に入らなければ使わないので(笑)'
                    ]
                },
                {
                    'title': 'メイクの持ちをよくする方法を教えて',
                    'content': '長時間の勤務でメイクが崩れやすいです。特に目元とファンデーションがヨレてしまいます。長持ちさせるコツはありますか？',
                    'category': '美容',
                    'answers': [
                        '下地選びが超重要です！油分の少ないさらっとした下地を使うと、崩れにくいですよ。あとは、ファンデーションの前後に軽くフェイスパウダーでおさえる「パウダーサンド」もおすすめです。休憩時間に鼻や額だけティッシュでおさえて、その上から少しだけパウダーを足すと長持ちします。',
                        'メイク直しグッズをしっかり持っておくことも大事です。特に夏場は油取り紙、冬場は保湿ミストを小まめに使うと違います。あと個人的には、アイメイクは落ちにくい日本製より、むしろ韓国コスメの方が持ちがいいと感じています。'
                    ]
                },
                {
                    'title': '体型維持のための食事管理について',
                    'content': '夜中に食事することが多く、体重が増えてきています。仕事をしながらダイエットするコツはありますか？',
                    'category': '美容',
                    'answers': [
                        '夜食を完全に抜くのは難しいので、低糖質・高タンパクなものを選ぶといいです。例えば、サラダチキンやゆで卵、豆腐などがおすすめ。炭水化物は極力控え、野菜中心にすると太りにくいです。あと、帰宅後すぐに食べるより、30分ほど時間を置いてから食べた方が消化もよくなります。',
                        '私は朝食をしっかり食べて、仕事前の食事を軽めにする方法で体重をキープしています。夜中に食べるとしても、スープや味噌汁など液体中心にするとむくみにくくなりますよ。'
                    ]
                },
                {
                    'title': 'お酒の席での上手な断り方',
                    'content': 'たまにしつこくお酒を勧めてくるお客様がいます。雰囲気を壊さずに断る方法はありますか？',
                    'category': '接客術',
                    'answers': [
                        '「今日はちょっと体調が…」と言いつつ、「でも〇〇さんのために乾杯だけは！」と言って少しだけ口をつけるのが無難です。あるいは「この後、別のお席があるので…」と断る方法もあります。完全に断るより、理由をつけて少しだけ付き合う姿勢を見せると、多くのお客様は理解してくれますよ。',
                        '私は「今日はここまでにしておきます」とはっきり言った上で、「代わりに〇〇さんのお話、もっと聞かせてくださいね」と話題を変えています。断ることより「何を提供するか」の方が大事だと思います。'
                    ]
                },
                {
                    'title': '指名が取れない日があると落ち込みます',
                    'content': '指名が多い日と全然ない日の差が激しく、メンタルが不安定になります。皆さんはどう乗り越えていますか？',
                    'category': 'メンタル',
                    'answers': [
                        '私もよくありました。大事なのは「1日の結果」ではなく「週単位」や「月単位」で考えること。調子のいい日も悪い日もあるのは当然です。指名がない日は、新規のお客様と出会うチャンスだと考えて、次につながる会話を心がけています。',
                        '指名が少ない日は自分を見直すいい機会です。髪型や服装、話し方などを少し変えてみると、新しい発見があったりします。あとは、先輩や同僚の接客を観察するのも勉強になりますよ。'
                    ]
                },
                {
                    'title': '社交辞令と本気の誘いの見分け方',
                    'content': 'お客様からLINE交換したいと言われることがありますが、社交辞令なのか本気なのか区別がつきません。皆さんはどう判断していますか？',
                    'category': '営業',
                    'answers': [
                        '基本は「全て社交辞令」だと思っておくべきです。でも、本気度を測るなら「具体的な約束をするか」がポイントです。「いつか飲みに行こう」は社交辞令、「来週の水曜日、19時に〇〇で」と具体的なら本気度高め。ただし、個人的なやり取りは店のルールに従った方がトラブル回避になります。',
                        '私は基本的にお店のシステム（連絡先カードなど）を通じてのみ連絡先を教えています。「お店のカードがあるので、そちらからご連絡ください」と伝えると、本当に連絡が欲しい人だけがアクションを起こします。これが一番トラブルが少ないです。'
                    ]
                },
                {
                    'title': '長く稼ぐためのキャリアプラン',
                    'content': '今26歳です。この仕事をあと何年続けるべきか、その後のキャリアも含めて考えています。長く業界にいる方のアドバイスをください。',
                    'category': 'スキルアップ',
                    'answers': [
                        '年齢より見た目と会話力が重要です。若くても会話がつまらなければ飽きられますし、逆に30代半ばでも魅力的な方はたくさんいます。大事なのは「次の一手」を常に考えておくこと。例えば、美容系の資格取得、副業の立ち上げ、投資の勉強など、並行して進めておくと安心です。',
                        '私は32歳で9年目です。20代後半から貯金と平行して、エステの資格を取りました。今はキャバ嬢とエステティシャンの二足のわらじで、将来はキャバ嬢時代の人脈を活かして自分のサロンを開く予定です。自分の強みを活かせる次のステップを考えておくと良いですよ。'
                    ]
                },
                {
                    'title': '先輩からのいじめ対処法',
                    'content': '特定の先輩から嫌がらせを受けています。無視、陰口、仕事の妨害など…。店長に言うべきか、耐えるべきか悩んでいます。',
                    'category': '人間関係',
                    'answers': [
                        '難しい問題ですね。まずは直接その先輩と2人で話す機会を作れるなら、「何か気に障ることをしましたか？」と率直に聞いてみるのも一つの方法です。それでも改善しない場合は、事実ベースで店長に相談するのがいいでしょう。感情的にならず、具体的な出来事を伝えることが大事です。',
                        '私も似た経験があります。結局、我慢してもいじめはエスカレートするだけでした。信頼できる先輩に間に入ってもらうか、どうしても解決しないなら環境を変えることも選択肢です。自分のメンタルを最優先に考えてください。'
                    ]
                },
                {
                    'title': '出勤前の体調管理術を教えてください',
                    'content': '前日の疲れや寝不足で出勤時に体調が優れないことがあります。皆さんはどうやって体調を整えていますか？',
                    'category': '出勤',
                    'answers': [
                        '睡眠の質を上げることが一番大事です。私は仕事から帰った後、すぐにお風呂に入って体を温め、スマホを見る時間を制限しています。また、ビタミンB群のサプリメントも疲労回復に効果的です。出勤前に軽い運動やストレッチをすると、血流が良くなって元気が出ますよ。',
                        '私は帰宅後すぐに食事をとらず、シャワーを浴びてからリラックスした状態で食べるようにしています。また、出勤2時間前には必ず目を覚まし、ゆっくり支度する時間を確保することで、精神的な余裕も生まれます。急いで準備すると一日中落ち着かない気分になりますよね。'
                    ]
                },
                {
                    'title': 'お客様からの過度な要求への対処法',
                    'content': 'たまにボディタッチや過度なサービスを要求してくるお客様がいます。雰囲気を壊さずに断る方法はありますか？',
                    'category': '接客術',
                    'answers': [
                        '笑顔で「うちのお店はそういうサービスはないんです」と店のルールを盾にするのが一番スマートです。個人的な判断ではなく、店のポリシーという形にすれば、お客様も反論しにくいですよ。それでも続くようなら、さりげなくフロアスタッフに目配せする等して助けを求めましょう。',
                        '私は「今日はごめんなさい」と柔らかく断りつつ、「でも楽しくお話はいっぱいしましょう」と代わりの楽しみ方を提案するようにしています。多くのお客様は一度しっかり線引きすると理解してくれますが、それでも理解しないお客様とは距離を置くしかありません。自分の身は自分で守ることが大切です。'
                    ]
                },
            ]
            
            # 質問と回答の作成
            for data in test_data:
                # 同じタイトルの質問が既に存在するかチェック
                existing_q = Question.query.filter_by(title=data['title']).first()
                if not existing_q:
                    q = Question(
                        title=data['title'],
                        content=data['content'],
                        user_id=user.id,
                        category_id=categories[data['category']].id,
                        is_deleted=False
                    )
                    db.session.add(q)
                    db.session.flush()  # IDを取得するためにflush
                    
                    # 回答の作成
                    for answer_text in data['answers']:
                        a = Answer(
                            content=answer_text,
                            question_id=q.id,
                            user_id=user.id,
                            is_deleted=False
                        )
                        db.session.add(a)
            
            db.session.commit()
            print('テストデータを投入しました')
            return True
            
        except Exception as e:
            db.session.rollback()
            print(f'テストデータ投入エラー: {str(e)}')
            return False

if __name__ == '__main__':
    insert_test_data()
